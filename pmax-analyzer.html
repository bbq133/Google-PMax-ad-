<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pmax æ™ºèƒ½è¯Šæ–­ä¸“å®¶ Pro</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-2: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--gradient-1);
            padding: 24px 32px;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-text h1 {
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .logo-text p {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        .demo-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .demo-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Main Layout */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 32px;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-body {
            padding: 20px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .auto-calc {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .auto-calc-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 4px 0;
        }

        .auto-calc-label {
            color: var(--text-muted);
        }

        .auto-calc-value {
            color: var(--accent-primary);
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-primary);
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            color: var(--text-muted);
        }

        .upload-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .upload-hint {
            font-size: 12px;
            color: var(--text-muted);
        }

        .file-input {
            display: none;
        }

        /* Content Area */
        .content {
            min-height: 500px;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 500px;
            background: var(--bg-card);
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            color: var(--text-muted);
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .empty-desc {
            font-size: 14px;
        }

        /* Report Section */
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .report-title {
            font-size: 22px;
            font-weight: 700;
        }

        .report-meta {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .badge-group {
            display: flex;
            gap: 8px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-critical {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-high {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge-medium {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge-good {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Campaign Card */
        .campaign-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .campaign-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .campaign-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .campaign-name {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .campaign-age {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-secondary);
        }

        .campaign-metrics {
            display: flex;
            gap: 24px;
        }

        .metric-item {
            text-align: right;
        }

        .metric-value {
            font-size: 16px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-good {
            color: var(--success);
        }

        .metric-warning {
            color: var(--warning);
        }

        .metric-danger {
            color: var(--danger);
        }

        .campaign-body {
            padding: 24px;
        }

        /* Issues List */
        .issues-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .issue-item {
            border-radius: 12px;
            padding: 16px 20px;
            border-left: 4px solid;
        }

        .issue-critical {
            background: rgba(239, 68, 68, 0.08);
            border-left-color: var(--danger);
        }

        .issue-high {
            background: rgba(245, 158, 11, 0.08);
            border-left-color: var(--warning);
        }

        .issue-medium {
            background: rgba(59, 130, 246, 0.08);
            border-left-color: var(--info);
        }

        .issue-good {
            background: rgba(16, 185, 129, 0.08);
            border-left-color: var(--success);
        }

        .issue-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .issue-module {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .issue-title {
            font-weight: 600;
            font-size: 15px;
        }

        .issue-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            padding-left: 4px;
            border-left: 2px solid var(--border-color);
            margin-left: 4px;
            padding-top: 4px;
            padding-bottom: 4px;
        }

        .issue-diagnosis {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .issue-action {
            font-size: 13px;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .issue-action-icon {
            color: var(--accent-primary);
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* No Issues */
        .no-issues {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .no-issues-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            color: var(--success);
        }

        .no-issues-text {
            font-size: 15px;
            font-weight: 500;
            color: var(--success);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main {
                grid-template-columns: 1fr;
                padding: 20px;
            }

            .sidebar {
                order: 1;
            }

            .content {
                order: 2;
            }
        }

        @media (max-width: 640px) {
            .header-content {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .campaign-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .campaign-metrics {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .campaign-card {
            animation: fadeIn 0.3s ease-out;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Re-analyze Button */
        .reanalyze-btn {
            width: 100%;
            margin-top: 16px;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--accent-primary), #7c3aed);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .reanalyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }

        .reanalyze-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .reanalyze-btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.5;
        }

        .reanalyze-btn svg {
            transition: transform 0.3s;
        }

        .reanalyze-btn:hover:not(:disabled) svg {
            transform: rotate(180deg);
        }

        /* Trigger Conditions Styles */
        .trigger-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .trigger-toggle {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--accent-primary);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .trigger-toggle:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.5);
        }

        .chevron-icon {
            width: 14px;
            height: 14px;
            transition: transform 0.2s;
            stroke-width: 2;
        }

        .trigger-toggle.expanded .chevron-icon {
            transform: rotate(180deg);
        }

        .trigger-details {
            margin-top: 12px;
            padding: 14px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 3px solid var(--accent-primary);
            display: none;
        }

        .trigger-details.show {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        .trigger-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .trigger-conditions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .condition-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            font-size: 12px;
        }

        .condition-check {
            color: var(--success);
            font-weight: bold;
            font-size: 14px;
            min-width: 16px;
        }

        .condition-label {
            flex: 1;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .condition-value {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            color: var(--text-primary);
            font-weight: 600;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .decision-path {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .path-label {
            color: var(--text-muted);
            font-weight: 500;
        }

        .path-value {
            color: var(--accent-primary);
            font-weight: 600;
            flex: 1;
        }
    </style>

</head>

<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                </div>
                <div class="logo-text">
                    <h1>Pmax æ™ºèƒ½è¯Šæ–­ä¸“å®¶ Pro</h1>
                    <p>æ”¯æŒ CSV æ•°æ®å¯¼å…¥ â€¢ æ—¶åºè¶‹åŠ¿åˆ†æ â€¢ æ·±åº¦å½’å› è¯Šæ–­</p>
                </div>
            </div>
            <button class="demo-btn" onclick="loadDemoData()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                åŠ è½½æ¼”ç¤ºæ•°æ®
            </button>
        </div>
    </header>

    <main class="main">
        <aside class="sidebar">
            <!-- Config Card -->
            <div class="card">
                <div class="card-header">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M12 1v6m0 6v6m11-7h-6m-6 0H1m19.07-7.07l-4.24 4.24m-5.66 5.66l-4.24 4.24m0-14.14l4.24 4.24m5.66 5.66l4.24 4.24">
                        </path>
                    </svg>
                    1. è®¾å®šä¸šåŠ¡ç›®æ ‡
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Target ROAS</label>
                        <input type="number" class="form-input" id="targetRoas" value="4.0" step="0.1"
                            onchange="updateConfig()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target CPA ($)</label>
                        <input type="number" class="form-input" id="targetCpa" value="50" step="1"
                            onchange="updateConfig()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target AOV ($)</label>
                        <input type="number" class="form-input" id="targetAov" value="150" step="10"
                            onchange="updateConfig()">
                    </div>
                    <div class="auto-calc">
                        <div class="auto-calc-row">
                            <span class="auto-calc-label">Auto CPATC:</span>
                            <span class="auto-calc-value" id="autoCpatc">$70</span>
                        </div>
                        <div class="auto-calc-row">
                            <span class="auto-calc-label">Auto CPIC:</span>
                            <span class="auto-calc-value" id="autoCpic">$70</span>
                        </div>
                    </div>
                    <button class="reanalyze-btn" id="reanalyzeBtn" onclick="reDiagnose()" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                        </svg>
                        é‡æ–°è¯Šæ–­
                    </button>
                </div>
            </div>

            <!-- Upload Card -->
            <div class="card">
                <div class="card-header">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    2. å¯¼å…¥æ•°æ®æŠ¥è¡¨
                </div>
                <div class="card-body">
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p class="upload-text">æ‹–æ‹½ CSV æ–‡ä»¶åˆ°æ­¤å¤„</p>
                        <p class="upload-hint">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    </div>
                    <input type="file" class="file-input" id="fileInput" accept=".csv"
                        onchange="handleFileUpload(event)">
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px; line-height: 1.5;">
                        ç³»ç»Ÿå°†è‡ªåŠ¨åˆå¹¶åŒä¸€ Campaign çš„å¤šå¤©æ•°æ®ï¼Œå¹¶å–æœ€æ–°æ—¥æœŸä½œä¸ºè¯Šæ–­åŸºå‡†ã€‚
                    </p>
                </div>
            </div>
        </aside>

        <section class="content" id="content">
            <div class="empty-state">
                <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
                <p class="empty-title">è¯·å¯¼å…¥æ•°æ®å¼€å§‹è¯Šæ–­</p>
                <p class="empty-desc">æ”¯æŒ CSV æ ¼å¼æ—¥æŠ¥è¡¨</p>
            </div>
        </section>
    </main>

    <script>
        // ============================================
        // é…ç½®
        // ============================================
        let config = {
            targetRoas: 4.0,
            targetCpa: 50,
            targetAov: 150,
            targetCpatc: 70,
            targetCpic: 70
        };

        function updateConfig() {
            config.targetRoas = parseFloat(document.getElementById('targetRoas').value) || 4.0;
            config.targetCpa = parseFloat(document.getElementById('targetCpa').value) || 50;
            config.targetAov = parseFloat(document.getElementById('targetAov').value) || 150;

            // è‡ªåŠ¨è®¡ç®— CPATC/CPIC
            config.targetCpatc = config.targetAov > 1000 ? 100 : 70;
            config.targetCpic = config.targetAov > 1000 ? 100 : 70;

            document.getElementById('autoCpatc').textContent = '$' + config.targetCpatc;
            document.getElementById('autoCpic').textContent = '$' + config.targetCpic;
        }

        // ============================================
        // å…¨å±€æ•°æ®å­˜å‚¨
        // ============================================
        let globalCampaignData = null; // å­˜å‚¨å·²å¤„ç†çš„å¹¿å‘Šç³»åˆ—æ•°æ®

        // é‡æ–°è¯Šæ–­å‡½æ•°
        function reDiagnose() {
            if (!globalCampaignData) {
                alert('è¯·å…ˆå¯¼å…¥æ•°æ®');
                return;
            }

            // é‡æ–°è¿è¡Œè¯Šæ–­
            const results = [];
            for (const campaignName in globalCampaignData) {
                const historyData = globalCampaignData[campaignName];
                const result = analyzeCampaign(historyData);
                if (result) {
                    results.push(result);
                }
            }

            // æ¸²æŸ“ç»“æœ
            renderResults(results);
        }

        // ============================================
        // æ•°æ®æ¸…æ´—å‡½æ•°
        // ============================================
        // ============================================
        // æ•°æ®æ¸…æ´—å‡½æ•°
        // ============================================
        function cleanNumber(val) {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            let str = String(val).trim();

            // å¤„ç† "<10"
            if (str.includes('<')) {
                str = str.replace(/[^0-9.]/g, '');
                return parseFloat(str) || 0;
            }

            // ç§»é™¤ %, $, ", comma
            // æ³¨æ„ï¼šå¯¹äº 97.60% è¿™ç§ï¼Œå»æ‰%åæ˜¯ 97.60ã€‚ä¸šåŠ¡é€»è¾‘é‡Œä½¿ç”¨ >50 åˆ¤æ–­ï¼Œæ‰€ä»¥ç›´æ¥å» % æ˜¯å¯¹çš„ã€‚
            // å¯¹äº 0.08% è¿™ç§ï¼Œå»æ‰%åæ˜¯ 0.08ã€‚ä¸šåŠ¡é€»è¾‘ <0.5ï¼Œä¹Ÿæ˜¯å¯¹çš„ã€‚
            str = str.replace(/[$,%"]/g, '').replace(/,/g, '');
            const num = parseFloat(str);
            return isNaN(num) ? 0 : num;
        }

        function parseDate(dateStr) {
            if (!dateStr) return new Date(0);
            return new Date(dateStr);
        }

        // ============================================
        // è¾…åŠ©å‡½æ•°
        // ============================================

        // è®¡ç®—ç¯æ¯”å˜åŒ–ç™¾åˆ†æ¯”
        function calculateChange(current, previous) {
            if (!previous || previous === 0) return 0;
            return (current - previous) / previous;
        }

        // æ£€æµ‹è¿ç»­è¶‹åŠ¿ (è¿”å› 'up', 'down', 'stable')
        function detectTrend(values, threshold = 0.1) {
            if (values.length < 2) return 'stable';
            let ups = 0, downs = 0;
            for (let i = 1; i < values.length; i++) {
                const change = calculateChange(values[i], values[i - 1]);
                if (change > threshold) ups++;
                else if (change < -threshold) downs++;
            }
            if (ups > downs) return 'up';
            if (downs > ups) return 'down';
            return 'stable';
        }

        // ============================================
        // è§¦å‘æ¡ä»¶ç›¸å…³å‡½æ•°
        // ============================================

        // åˆ‡æ¢è§¦å‘æ¡ä»¶æ˜¾ç¤º
        function toggleTrigger(button) {
            const details = button.nextElementSibling;
            const isExpanded = details.classList.contains('show');

            if (isExpanded) {
                details.classList.remove('show');
                button.classList.remove('expanded');
                button.innerHTML = `
                    <svg class="chevron-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                    æŸ¥çœ‹è§¦å‘æ¡ä»¶
                `;
            } else {
                details.classList.add('show');
                button.classList.add('expanded');
                button.innerHTML = `
                    <svg class="chevron-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                    æ”¶èµ·è§¦å‘æ¡ä»¶
                `;
            }
        }

        // æ ¼å¼åŒ–æ•°å€¼
        function formatValue(value, format) {
            if (value === null || value === undefined) return 'N/A';
            switch (format) {
                case 'currency':
                    return '$' + value.toFixed(2);
                case 'percentage':
                    return value.toFixed(2) + '%';
                default:
                    return value.toString();
            }
        }

        // æ¸²æŸ“è§¦å‘æ¡ä»¶åŒºå—
        function renderTriggerSection(issue) {
            if (!issue.triggerConditions || issue.triggerConditions.length === 0) {
                return '';
            }

            const conditionsHTML = issue.triggerConditions.map(cond => `
                <div class="condition-item">
                    <span class="condition-check">${cond.passed ? 'âœ“' : 'âœ—'}</span>
                    <span class="condition-label">${cond.label}</span>
                    <span class="condition-value">${formatValue(cond.actual, cond.format)} ${cond.operator} ${formatValue(cond.threshold, cond.format)}</span>
                </div>
            `).join('');

            const decisionPathHTML = issue.decisionPath ? `
                <div class="decision-path">
                    <span class="path-label">åˆ¤æ–­è·¯å¾„:</span>
                    <span class="path-value">${issue.decisionPath}</span>
                </div>
            ` : '';

            return `
                <div class="trigger-section">
                    <button class="trigger-toggle" onclick="toggleTrigger(this)">
                        <svg class="chevron-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                        æŸ¥çœ‹è§¦å‘æ¡ä»¶
                    </button>
                    <div class="trigger-details">
                        <div class="trigger-header">ğŸ“Š è§¦å‘æ¡ä»¶è¯¦æƒ…</div>
                        <div class="trigger-conditions">
                            ${conditionsHTML}
                        </div>
                        ${decisionPathHTML}
                    </div>
                </div>
            `;
        }


        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return [];

            // ä½¿ç”¨æ­£åˆ™åˆ†å‰² CSV è¡Œï¼Œæ­£ç¡®å¤„ç†å¼•å·å†…çš„é€—å·
            // åŒ¹é…è§„åˆ™ï¼šé€—å·ï¼Œåé¢è·Ÿç€å¶æ•°ä¸ªå¼•å·ï¼ˆè¡¨ç¤ºæˆ‘ä»¬åœ¨å¼•å·å¤–ï¼‰
            const splitPattern = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;

            const headers = lines[0].split(splitPattern).map(h => h.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
            const rawData = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                // è·³è¿‡ç©ºè¡Œ
                if (!line) continue;

                const values = line.split(splitPattern).map(v => v.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));

                // å…è®¸ä¸€å®šçš„å®½å®¹åº¦
                if (values.length > 0) {
                    const row = {};
                    headers.forEach((h, idx) => {
                        row[h] = values[idx] || '';
                    });
                    rawData.push(row);
                }
            }

            return rawData;
        }

        // ============================================
        // æ ¸å¿ƒè¯Šæ–­å¼•æ“
        // ============================================
        function analyzeCampaign(historyData) {
            const issues = [];

            if (!historyData || historyData.length === 0) {
                return { data: {}, issues: [] };
            }

            const today = historyData[0];
            const yesterday = historyData[1] || {};
            const dayBefore = historyData[2] || {};

            // æ±‡æ€»å¤šå¤©æ•°æ®ä»¥è·å¾—å‡†ç¡®çš„æ€»ä½“æŒ‡æ ‡
            let totalCost = 0;
            let totalConversions = 0;
            let totalConvValue = 0;
            let totalClicks = 0;
            let totalImpressions = 0;
            let totalAtc = 0;
            let totalIc = 0;

            historyData.forEach(row => {
                totalCost += cleanNumber(row['Cost']);
                totalConversions += cleanNumber(row['Purchase']);
                totalConvValue += cleanNumber(row['é”€å”®é¢']);
                totalClicks += cleanNumber(row['Clicks']);
                totalImpressions += cleanNumber(row['Impr.']);
                totalAtc += cleanNumber(row['ATC']);
                totalIc += cleanNumber(row['IC']);
            });

            // è®¡ç®—æ±‡æ€»åçš„æŒ‡æ ‡
            const aggregatedRoas = totalCost > 0 ? totalConvValue / totalCost : 0;
            const aggregatedCpa = totalConversions > 0 ? totalCost / totalConversions : 0;
            const aggregatedAov = totalConversions > 0 ? totalConvValue / totalConversions : 0;
            const aggregatedCvr = totalClicks > 0 ? (totalConversions / totalClicks) * 100 : 0;
            const aggregatedCtr = totalImpressions > 0 ? (totalClicks / totalImpressions) * 100 : 0;

            // æå–å¹¶æ¸…æ´—æ•°æ® - ä½¿ç”¨æ±‡æ€»æ•°æ®ä½œä¸ºä¸»è¦æŒ‡æ ‡
            const data = {
                name: today['Campaign'] || 'Unknown',
                date: today['Day'],
                age: historyData.length,  // ä½¿ç”¨å®é™…æ•°æ®å¤©æ•°
                cost: totalCost,  // ä½¿ç”¨æ±‡æ€»å€¼
                budget: cleanNumber(today['Budget']),
                clicks: totalClicks,  // ä½¿ç”¨æ±‡æ€»å€¼
                impressions: totalImpressions,  // ä½¿ç”¨æ±‡æ€»å€¼
                conversions: totalConversions,  // ä½¿ç”¨æ±‡æ€»å€¼
                convValue: totalConvValue,  // ä½¿ç”¨æ±‡æ€»å€¼
                atc: totalAtc,  // ä½¿ç”¨æ±‡æ€»å€¼
                ic: totalIc,  // ä½¿ç”¨æ±‡æ€»å€¼
                cpm: cleanNumber(today['CPM']),  // æœ€æ–°ä¸€å¤©çš„CPM
                cpc: cleanNumber(today['CPC']),  // æœ€æ–°ä¸€å¤©çš„CPC
                ctr: aggregatedCtr,  // ä½¿ç”¨æ±‡æ€»è®¡ç®—çš„CTR
                cvr: aggregatedCvr,  // ä½¿ç”¨æ±‡æ€»è®¡ç®—çš„CVR
                roas: aggregatedRoas,  // ä½¿ç”¨æ±‡æ€»è®¡ç®—çš„ROAS
                cpa: aggregatedCpa,  // ä½¿ç”¨æ±‡æ€»è®¡ç®—çš„CPA
                aov: aggregatedAov,  // ä½¿ç”¨æ±‡æ€»è®¡ç®—çš„AOV
                displayVideoCostShare: cleanNumber(today['ç‰ˆä½è·‘åè¯Šæ–­ï¼ˆcostï¼šdisplay+videoå æ¯”ï¼‰']),
                policyStatus: today['Policy Review Status'] || 'Eligible',
                gmcStatus: today['GMC Status'] || 'Active',
                assetStatus: today['Asset Approval Status'] || '',
                // å†å²å¯¹æ¯”æ•°æ®
                prevCpm: cleanNumber(yesterday['CPM']),
                prevCtr: cleanNumber(yesterday['CTR']),
                prevCost: cleanNumber(yesterday['Cost']),
                prevIc: cleanNumber(yesterday['IC']),
                yesterdayConversions: cleanNumber(yesterday['Purchase']),
                dayBeforeYesterdayCpm: cleanNumber(dayBefore['CPM']),
                dayBeforeYesterdayImpressions: cleanNumber(dayBefore['Impr.'])
            };

            // è¾…åŠ©è®¡ç®—
            const cpatc = data.atc > 0 ? data.cost / data.atc : 0;
            const cpic = data.ic > 0 ? data.cost / data.ic : 0;
            const benchmarkCpatc = config.targetCpatc;
            const benchmarkCpic = config.targetCpic;

            // ç¯æ¯”å˜åŒ–è®¡ç®—
            const cpmChange = calculateChange(data.cpm, data.prevCpm);
            const costChange = calculateChange(cleanNumber(today['Cost']), data.prevCost);
            const cvrChange = calculateChange(data.cvr, cleanNumber(yesterday['CVR']));

            // === æ¨¡å—ä¸€ï¼šåŸºå»ºè¯Šæ–­ ===

            // 1.1 å®¡æ ¸çŠ¶æ€æ£€æŸ¥ - å¢å¼ºç‰ˆ (æ£€æµ‹æ¶ˆè€—éª¤é™)
            if (data.policyStatus && (data.policyStatus.toLowerCase().includes('limit') || data.policyStatus.toLowerCase().includes('disapproved'))) {
                // æ£€æŸ¥æ˜¯å¦ä¼´éšæ¶ˆè€—éª¤é™
                const hasCostDrop = costChange < -0.4; // 40% ä¸‹é™
                issues.push({
                    level: hasCostDrop ? 'CRITICAL' : 'HIGH',
                    module: 'åŸºå»ºè¯Šæ–­',
                    title: hasCostDrop ? 'ç´ æ/å•†å“æ‹’ç™» + æ¶ˆè€—éª¤é™' : 'ç´ æ/å•†å“æ‹’ç™»é£é™©',
                    desc: `Policy Status: ${data.policyStatus}${hasCostDrop ? `, æ¶ˆè€—ç¯æ¯”ä¸‹é™ ${Math.abs(costChange * 100).toFixed(0)}%` : ''}`,
                    diagnosis: 'å­˜åœ¨è¿è§„æˆ–å—é™å†…å®¹ã€‚' + (hasCostDrop ? 'æ¶ˆè€—éª¤é™è¯´æ˜é—®é¢˜ä¸¥é‡ã€‚' : ''),
                    action: 'æ ¹æ®æ‹’ç»åŸå› (å¦‚:æˆäººå†…å®¹ã€è™šå‡é™ˆè¿°ã€å•†æ ‡ä¾µæƒ)è¿›è¡Œç”³è¯‰æˆ–ä¿®æ”¹ç´ æã€‚'
                });
            }

            // 1.2 GMC çŠ¶æ€
            if (data.gmcStatus && data.gmcStatus.toLowerCase().includes('disapproved')) {
                issues.push({
                    level: 'CRITICAL',
                    module: 'åŸºå»ºè¯Šæ–­',
                    title: 'GMC è´¦æˆ·å¼‚å¸¸',
                    desc: `GMC Status: ${data.gmcStatus}`,
                    diagnosis: 'ä¾›è¡€ä¸è¶³ï¼Œå•†å“è¢«æ‹’ã€‚',
                    action: 'ä¿®å¤ Merchant Center Feedã€‚'
                });
            }

            // === æ¨¡å—äºŒï¼šå¹¿å‘Šè¯Šæ–­ ===
            const isLearning = data.age <= 3;

            if (isLearning) {
                // === å­¦ä¹ æœŸ (0-3å¤©) ===

                // åœºæ™¯ A: æ¶ˆè€—è¿‡çƒ­
                if (data.cost > data.budget * 1.2) {
                    if (data.roas > config.targetRoas && data.cpa < config.targetCpa) {
                        issues.push({
                            level: 'GOOD',
                            module: 'å­¦ä¹ æœŸ-é¢„ç®—',
                            title: 'æ¶ˆè€—è¿‡çƒ­ - è‰¯æ€§',
                            desc: `è¶…é¢„ç®— ${((data.cost / data.budget - 1) * 100).toFixed(0)}% ä½†æ•ˆæœä½³`,
                            diagnosis: 'æ¿€è¿›æ¢ç´¢ä¸­ï¼ŒROAS å’Œ CPA å‡è¾¾æ ‡ã€‚',
                            action: 'ä¸å¹²é¢„æˆ–åŠ é¢„ç®—ï¼Œè®©æœºå™¨ç»§ç»­å­¦ä¹ ã€‚'
                        });
                    } else {
                        issues.push({
                            level: 'MEDIUM',
                            module: 'å­¦ä¹ æœŸ-é¢„ç®—',
                            title: 'æ¶ˆè€—è¿‡çƒ­ - éœ€è§‚å¯Ÿ',
                            desc: `è¶…é¢„ç®— >20%ï¼ŒCost: $${data.cost.toFixed(2)}`,
                            diagnosis: 'æ­£å¸¸æ³¢åŠ¨ï¼Œç­‰å¾…å­¦ä¹ å®Œæˆã€‚',
                            action: 'è§‚å¯Ÿè‡³ç¬¬4å¤©å†å†³å®šæ˜¯å¦å¹²é¢„ã€‚'
                        });
                    }
                }

                // åœºæ™¯ B: æ¶ˆè€—ä¸è¶³
                if (data.cost < data.budget * 0.8) {
                    if (data.cpa < config.targetCpa) {
                        issues.push({
                            level: 'MEDIUM',
                            module: 'å­¦ä¹ æœŸ-é¢„ç®—',
                            title: 'æ¶ˆè€—ä¸è¶³ - ä¿å®ˆ',
                            desc: `èŠ±ä¸å‡ºé’±ä¸” CPA($${data.cpa.toFixed(2)}) ä½äºç›®æ ‡`,
                            diagnosis: 'å‡ºä»·è¿‡äºä¿å®ˆï¼Œç«äº‰ä¸åˆ°æµé‡ã€‚',
                            action: 'æé¢„ç®—æˆ–æ”¾å®½ ROAS/CPA é™åˆ¶ã€‚'
                        });
                    } else {
                        issues.push({
                            level: 'MEDIUM',
                            module: 'å­¦ä¹ æœŸ-é¢„ç®—',
                            title: 'æ¶ˆè€—ä¸è¶³ - ç«äº‰åŠ›å·®',
                            desc: 'èŠ±ä¸å‡ºé’±ä¸”æ•ˆæœå·®',
                            diagnosis: 'ç«äº‰åŠ›ä¸è¶³ï¼Œå¯èƒ½ç›®æ ‡è®¾å®šè¿‡äºæ¿€è¿›ã€‚',
                            action: 'é™ä½ tROAS ç›®æ ‡ (å¦‚ 4.0 â†’ 3.5)ã€‚'
                        });
                    }
                }

                // æµ…å±‚äº¤äº’å¼‚å¸¸: æœ‰ç‚¹å‡»æ— åŠ è´­
                if (data.clicks > 100 && data.atc < 2) {
                    issues.push({
                        level: 'HIGH',
                        module: 'å­¦ä¹ æœŸ-äº¤äº’',
                        title: 'æœ‰ç‚¹å‡»æ— åŠ è´­',
                        desc: `Click: ${data.clicks}, ATC: ${data.atc}`,
                        diagnosis: 'ç´ æè¯¯å¯¼ / è½åœ°é¡µä½“éªŒå·® / ä»·æ ¼æ— ç«äº‰åŠ›ã€‚',
                        action: '1. æŸ¥ GMC ä»·æ ¼ç«äº‰åŠ›ï¼Œä¼˜åŒ–è½åœ°é¡µ CTA; 2. æ¢ä¿¡å·: æš‚åœå®½æ³›çš„"å…´è¶£"æ ‡ç­¾ï¼Œæ”¹ç”¨æ›´ç²¾å‡†çš„"ç«å“è¯/æ ¸å¿ƒè¯"ä½œä¸º Search Themes; 3. æŸ¥è½åœ°é¡µé¦–å±æ˜¯å¦æ¸…æ™°å±•ç¤ºä»·æ ¼å’Œ CTA æŒ‰é’®ã€‚'
                    });
                }

                // ä¸­å±‚äº¤äº’å¼‚å¸¸: åŠ è´­ä¸ç»“è´¦æ•°æ®å°‘ (Low ATC/Checkout & High CPA)
                const hasHighCpatc = cpatc > benchmarkCpatc;
                const hasHighCpic = cpic > benchmarkCpic;
                const lowInteraction = data.cost > 200 && (data.atc + data.ic) < 3;

                if ((hasHighCpatc && hasHighCpic) || lowInteraction) {
                    issues.push({
                        level: 'HIGH',
                        module: 'å­¦ä¹ æœŸ-äº¤äº’',
                        title: 'ä¸­å±‚äº¤äº’å¼‚å¸¸ (åŠ è´­/ç»“è´¦æˆæœ¬é«˜)',
                        desc: `CPATC: $${cpatc.toFixed(2)} (åŸºå‡†: $${benchmarkCpatc}), CPIC: $${cpic.toFixed(2)} (åŸºå‡†: $${benchmarkCpic})`,
                        diagnosis: 'æµé‡è¿›æ¥äº†ï¼Œä½†å…¨æ˜¯"æ— æ•ˆäººç¾¤"(å¦‚å¯¹ä»·æ ¼æåº¦æ•æ„Ÿï¼Œæˆ–è¯¯ç‚¹)ã€‚å¯èƒ½æ˜¯ç‰ˆä½åç§»æˆ–äº‹ä»¶è¿½è¸ªé—®é¢˜ã€‚',
                        action: '1. [Tech Check] æ£€æŸ¥ Add to Cart å’Œ Begin Checkout äº‹ä»¶çŠ¶æ€æ˜¯å¦æ­£å¸¸; 2. [Placement Scrub] æ£€æŸ¥ Video/Display ç‰ˆä½çš„ CPA æ˜¯å¦è¿œé«˜äº Shopping ç‰ˆä½; 3. [Audience Tuning] æš‚åœå®½æ³› Interestsï¼Œæ–°å¢ High Intent ä¿¡å·; 4. [Offer Check] å¯¹æ¯”ä»·æ ¼ï¼Œæ£€æŸ¥æ˜¯å¦å¤„äºéæŠ˜æ‰£æœŸã€‚',
                        triggerConditions: [
                            {
                                label: 'CPATC > Benchmark',
                                actual: cpatc,
                                threshold: benchmarkCpatc,
                                operator: '>',
                                passed: hasHighCpatc,
                                format: 'currency'
                            },
                            {
                                label: 'CPIC > Benchmark',
                                actual: cpic,
                                threshold: benchmarkCpic,
                                operator: '>',
                                passed: hasHighCpic,
                                format: 'currency'
                            },
                            {
                                label: 'ATC + IC < 3 (Cost > $200)',
                                actual: data.atc + data.ic,
                                threshold: 3,
                                operator: '<',
                                passed: lowInteraction,
                                format: 'number'
                            }
                        ],
                        decisionPath: 'å­¦ä¹ æœŸ â†’ ä¸­å±‚äº¤äº’æ£€æµ‹ â†’ æˆæœ¬è¶…æ ‡/ä½äº¤äº’'
                    });
                }

                // æ·±å±‚äº¤äº’å¼‚å¸¸: é«˜æ„å‘ä½†é›¶è½¬åŒ– (High Intent but Zero Conversion)
                const highIntent = (data.atc + data.ic) > 5;
                const zeroConversion = data.conversions === 0 && data.yesterdayConversions === 0;

                if (highIntent && zeroConversion) {
                    issues.push({
                        level: 'CRITICAL',
                        module: 'å­¦ä¹ æœŸ-äº¤äº’',
                        title: 'æ·±å±‚äº¤äº’å¼‚å¸¸ (é«˜æ„å‘ä½†é›¶è½¬åŒ–)',
                        desc: `ATC + IC = ${data.atc + data.ic}ï¼Œä½†è¿ç»­ 0 è½¬åŒ–`,
                        diagnosis: 'ç”¨æˆ·éƒ½å·²ç»æ‹¿èµ·å•†å“èµ°åˆ°æ”¶é“¶å°äº†ï¼Œæœ€åå´æ”¾ä¸‹èµ°äº†ã€‚å¯èƒ½æ˜¯æ”¯ä»˜åäº†ã€è¿è´¹æƒŠå“ã€ä¿ƒé”€å¤±æ•ˆæˆ–ç«å“æˆªèƒ¡ã€‚',
                        action: '1. [P0çº§æµ‹è¯•] ç«‹å³æµ‹è¯•æ”¯ä»˜é€šé“; 2. [Marketing] æ£€æŸ¥å¹¿å‘Šç´ æä¸ç½‘ç«™æ´»åŠ¨æ˜¯å¦ä¸€è‡´ï¼Œä¼˜æƒ ç æ˜¯å¦æœ‰æ•ˆ; 3. [Ops] å¿«é€ŸæŸ¥çœ‹æ ¸å¿ƒç«å“å½“å‰å”®ä»·; 4. [Settings] æ£€æŸ¥æ˜¯å¦æŠ•åˆ°äº†ä¸å‘è´§çš„åè¿œåœ°åŒºã€‚',
                        triggerConditions: [
                            {
                                label: 'ATC + IC > 5',
                                actual: data.atc + data.ic,
                                threshold: 5,
                                operator: '>',
                                passed: true,
                                format: 'number'
                            },
                            {
                                label: 'è¿ç»­ 0 è½¬åŒ– (ä»Šå¤©+æ˜¨å¤©)',
                                actual: data.conversions + data.yesterdayConversions,
                                threshold: 0,
                                operator: '=',
                                passed: true,
                                format: 'number'
                            }
                        ],
                        decisionPath: 'å­¦ä¹ æœŸ â†’ æ·±å±‚äº¤äº’æ£€æµ‹ â†’ é«˜æ„å‘é›¶è½¬åŒ–'
                    });
                }

                // ç‰ˆä½è·‘å (å­¦ä¹ æœŸ)
                if (data.displayVideoCostShare > 50) {
                    issues.push({
                        level: 'HIGH',
                        module: 'å­¦ä¹ æœŸ-ç‰ˆä½',
                        title: 'ç‰ˆä½è·‘å (Display/Video > 50%)',
                        desc: `Display+Video æ¶ˆè€—å æ¯” ${data.displayVideoCostShare.toFixed(1)}%`,
                        diagnosis: 'å·æ‡’å¼å­¦ä¹ ï¼Œè·‘å‘ä½æ•ˆç‰ˆä½ã€‚',
                        action: '1. æ’é™¤ App ç±»ç›®; 2. åŠ ç«å“è¯ Search Themes; 3. ä¸Šä¼ åŸç”Ÿè§†é¢‘ã€‚'
                    });
                }

            } else {
                // === ç¨³å®šæœŸ (4å¤©+) ===

                // åœºæ™¯ A: æ¶ˆè€—è¿‡çƒ­
                if (data.cost > data.budget * 1.2) {
                    // åˆ¤æ–­é€»è¾‘ 1: è‰¯æ€§æŠ¢é‡
                    const cvrStable = Math.abs(cvrChange) < 0.1; // CVR å˜åŠ¨å¹…åº¦ < 10%
                    const cpaGood = data.cpa < config.targetCpa * 1.2;

                    if (cvrStable && cpaGood) {
                        issues.push({
                            level: 'GOOD',
                            module: 'ç¨³å®šæœŸ-é¢„ç®—',
                            title: 'è‰¯æ€§æŠ¢é‡ (Healthy Aggressive)',
                            desc: `è¶…é¢„ç®— ${((data.cost / data.budget - 1) * 100).toFixed(0)}%ï¼Œä½† CVR ç¨³å®šä¸” CPA è¾¾æ ‡`,
                            diagnosis: 'æœºå™¨å‘ç°äº†é«˜è½¬åŒ–æœºä¼šï¼Œæ­£åœ¨ç§¯ææ‰©é‡ã€‚è™½ç„¶è¶…é¢„ç®—ï¼Œä½†æ¯ä¸€åˆ†é’±éƒ½èŠ±åœ¨äº†åˆ€åˆƒä¸Šã€‚',
                            action: 'ä¸å¹²é¢„ æˆ– åŠ é¢„ç®—ã€‚ä¸è¦æ‰“æ–­æœºå™¨çš„å…´å¥‹çŠ¶æ€ã€‚'
                        });
                    } else {
                        // åˆ¤æ–­é€»è¾‘ 2: æ¶æ€§æš´å†²
                        issues.push({
                            level: 'HIGH',
                            module: 'ç¨³å®šæœŸ-é¢„ç®—',
                            title: 'æ¶æ€§æš´å†²',
                            desc: `æ¶ˆè€—æ¿€å¢ä½†æ•ˆæœå·® (CVR: ${data.cvr.toFixed(2)}%, CPA: $${data.cpa.toFixed(0)})`,
                            diagnosis: 'æµé‡è´¨é‡ä¸‹é™ã€‚æœºå™¨å¯èƒ½è·‘åˆ°äº†æ˜‚è´µä½†è½¬åŒ–å·®çš„ç‰ˆä½ï¼Œæˆ–è€…æ˜¯è¢«ä½æ•ˆçš„ Display æµé‡å¡«å……äº†é¢„ç®—ã€‚',
                            action: '1. [æ§é¢„ç®—] ç«‹å³å°†é¢„ç®—å›è°ƒ; 2. [æ£€æŸ¥CPM] é‡ç‚¹æ£€æŸ¥ CPM æ˜¯å¦æš´è·Œ(åƒåœ¾æµé‡)æˆ– Search Terms æ˜¯å¦è¿‡äºå®½æ³›ã€‚',
                            triggerConditions: [
                                {
                                    label: 'Cost > Budget Ã— 1.2',
                                    actual: data.cost,
                                    threshold: data.budget * 1.2,
                                    operator: '>',
                                    passed: true,
                                    format: 'currency'
                                },
                                {
                                    label: 'CVR < 0.5% æˆ– CPA è¶…æ ‡',
                                    actual: data.cvr < 0.5 ? data.cvr : data.cpa,
                                    threshold: data.cvr < 0.5 ? 0.5 : config.targetCpa * 1.2,
                                    operator: '<',
                                    passed: true,
                                    format: data.cvr < 0.5 ? 'percentage' : 'currency'
                                }
                            ],
                            decisionPath: 'ç¨³å®šæœŸ â†’ æ¶ˆè€—è¿‡çƒ­ â†’ æ¶æ€§æš´å†²'
                        });
                    }
                }

                // åœºæ™¯ B: æ¶ˆè€—ä¸è¶³
                if (data.cost < data.budget * 0.8) {
                    // åˆ¤æ–­é€»è¾‘ 1: é«˜æ•ˆç‡ (High Efficiency)
                    const highRoas = data.roas > 5.0;
                    const lowCpic = cpic < benchmarkCpic;

                    if (highRoas || lowCpic) {
                        issues.push({
                            level: 'MEDIUM',
                            module: 'ç¨³å®šæœŸ-é¢„ç®—',
                            title: 'æ¶ˆè€—ä¸è¶³ - é«˜æ•ˆç‡',
                            desc: `æ¶ˆè€—ä»…è¾¾é¢„ç®— ${((data.cost / data.budget) * 100).toFixed(0)}%, ROAS: ${data.roas.toFixed(2)}`,
                            diagnosis: 'é¢„ç®—æ’çº¿æœºä¼šã€‚è½¬åŒ–æ•ˆæœæå¥½(ç»“è´¦æˆæœ¬å¾ˆä½)ï¼Œä½†å¯èƒ½å—é™äº tROAS ç›®æ ‡è®¾å¾—å¤ªé«˜(å¦‚ 600%)ï¼Œå¯¼è‡´æœºå™¨ä¸æ•¢æ”¾å¼€æ‰‹è„šå‡ºä»·ã€‚',
                            action: '1. [åŠ é¢„ç®—] æ‹‰é«˜ 30% é¢„ç®—åˆºæ¿€æ¶ˆè€—; 2. [é™é—¨æ§›] é€‚å½“é™ä½ tROAS ç›®æ ‡(å¦‚ 500% â†’ 450%)ï¼Œç”¨ç¨å¾®ä½ä¸€ç‚¹çš„æ•ˆç‡æ¢å–æ›´å¤šçš„å•é‡ã€‚'
                        });
                    } else if (data.roas < 4.0 && (cpic > benchmarkCpic || data.atc === 0)) {
                        // åˆ¤æ–­é€»è¾‘ 2: ä½æ•ˆèƒ½ (Low Efficiency)
                        issues.push({
                            level: 'HIGH',
                            module: 'ç¨³å®šæœŸ-é¢„ç®—',
                            title: 'æ¶ˆè€—ä¸è¶³ - ä½æ•ˆèƒ½',
                            desc: `æ¶ˆè€—ä»…è¾¾é¢„ç®— ${((data.cost / data.budget) * 100).toFixed(0)}%, ROAS: ${data.roas.toFixed(2)}, CPIC é«˜äºåŸºå‡†`,
                            diagnosis: '"æœ‰ä»·æ— å¸‚"ã€‚è™½ç„¶æ²¡èŠ±å®Œé’±ï¼Œä½†å·²ç»å¾ˆè´µäº†ã€‚è¯´æ˜ç´ æç‚¹å‡»ç‡å¤ªä½(è·‘ä¸å‡ºé‡)æˆ–è€…äº§å“ç¼ºä¹ç«äº‰åŠ›(ç”¨æˆ·çœ‹äº†ä¸åŠ è´­)ã€‚',
                            action: '1. æ£€æŸ¥ç´ æ CTR æ˜¯å¦ < 0.8%? â†’ æ¢ç´ æ; 2. æ£€æŸ¥æ˜¯å¦æœ‰ ATC ä½†æ—  Purchase? â†’ æŸ¥ä»·æ ¼/è¿è´¹ã€‚'
                        });
                    }
                }

                // CVR å¼‚å¸¸ - è™šå‡ç¹è£
                const cpmDrop = data.prevCpm > 0 ? (data.cpm - data.prevCpm) / data.prevCpm : 0;
                if (data.cvr < 0.5 && cpmDrop < -0.2 && cpatc > benchmarkCpatc) {
                    issues.push({
                        level: 'HIGH',
                        module: 'ç¨³å®šæœŸ-CVR',
                        title: 'è™šå‡ç¹è£ (Cheap & Useless)',
                        desc: `CPM ç¯æ¯”è·Œ ${(cpmDrop * 100).toFixed(1)}%ï¼ŒåŠ è´­æˆæœ¬é«˜`,
                        diagnosis: 'åƒåœ¾æµé‡æ¶Œå…¥ (Display/App)ã€‚',
                        action: '1. ç‰ˆä½æ¸…æ´— (æ’é™¤ App); 2. æ£€æŸ¥ Final URL Expansionã€‚'
                    });
                }

                // CVR å¼‚å¸¸ - å…¨é¢å´©ç›˜
                if (data.cvr < 0.5 && data.ctr < 0.5 && cpatc > benchmarkCpatc) {
                    issues.push({
                        level: 'CRITICAL',
                        module: 'ç¨³å®šæœŸ-CVR',
                        title: 'å…¨é¢å´©ç›˜ (No Click, No Buy)',
                        desc: `CTR: ${data.ctr.toFixed(2)}%, CVR: ${data.cvr.toFixed(2)}%`,
                        diagnosis: 'ç´ æä¸å—ä¼—ä¸¥é‡é”™é…ã€‚',
                        action: '1. æ›¿æ¢æœ€å·®ç´ æ; 2. æš‚åœå®½æ³› Interestsï¼Œæ”¹ç”¨ Search Themesã€‚'
                    });
                }

                // CVR å¼‚å¸¸ - ä¸´é—¨ä¸€è„š (Good Traffic, Bad Offer)
                const cpmStable = Math.abs(cpmChange) < 0.1; // CPM å˜åŒ–å°äº 10%
                const goodAtcCost = cpatc < benchmarkCpatc;
                const badIcCost = cpic > benchmarkCpic;

                if (data.cvr < 0.5 && cpmStable && goodAtcCost && badIcCost) {
                    issues.push({
                        level: 'HIGH',
                        module: 'ç¨³å®šæœŸ-CVR',
                        title: 'ä¸´é—¨ä¸€è„š (Good Traffic, Bad Offer)',
                        desc: `æµé‡è´¨é‡æ­£å¸¸(CPATC: $${cpatc.toFixed(2)}), ä½†ç»“è´¦æˆæœ¬é«˜(CPIC: $${cpic.toFixed(2)})`,
                        diagnosis: '"äºº"æ˜¯å¯¹çš„ï¼Œ"è´§/åœº"æœ‰é—®é¢˜ã€‚æµé‡è´¨é‡æ²¡å˜(åŠ è´­æˆæœ¬å¥åº·)ï¼Œä½†é¡µé¢æ‰¿æ¥èƒ½åŠ›æˆ–ä»·æ ¼ç­–ç•¥å¤±æ•ˆï¼Œå¯¼è‡´ç”¨æˆ·åœ¨æœ€åç¯èŠ‚æµå¤±ã€‚',
                        action: '1. [Inventory] æ ¸å¿ƒçˆ†æ¬¾æ˜¯å¦æ–­è´§æˆ–æ–­ç ? 2. [Competition] æ£€æŸ¥ç«å“æ˜¯å¦æ­£åœ¨é™ä»·? 3. [Tech] æ£€æŸ¥è½åœ°é¡µ/ç»“è´¦é¡µåŠ è½½é€Ÿåº¦ï¼Œæˆ–æ˜¯å¦æœ‰é®æŒ¡è½¬åŒ–çš„å¼¹çª—ã€‚',
                        triggerConditions: [
                            {
                                label: 'CVR < 0.5%',
                                actual: data.cvr,
                                threshold: 0.5,
                                operator: '<',
                                passed: true,
                                format: 'percentage'
                            },
                            {
                                label: 'CPM å˜åŒ– < 10%',
                                actual: Math.abs(cpmChange * 100),
                                threshold: 10,
                                operator: '<',
                                passed: cpmStable,
                                format: 'percentage'
                            },
                            {
                                label: 'CPATC < Benchmark',
                                actual: cpatc,
                                threshold: benchmarkCpatc,
                                operator: '<',
                                passed: goodAtcCost,
                                format: 'currency'
                            },
                            {
                                label: 'CPIC > Benchmark',
                                actual: cpic,
                                threshold: benchmarkCpic,
                                operator: '>',
                                passed: badIcCost,
                                format: 'currency'
                            }
                        ],
                        decisionPath: 'ç¨³å®šæœŸ â†’ CVRå¼‚å¸¸æ£€æµ‹ â†’ ä¸´é—¨ä¸€è„š'
                    });
                }

                // CPM ä¸‹é™è¯Šæ–­ (æµé‡é™çº§é£é™©)
                const yesterdayCpm = data.prevCpm;
                const dayBeforeCpm = data.dayBeforeYesterdayCpm;
                const cpmDropVsDayBefore = calculateChange(yesterdayCpm, dayBeforeCpm);
                const impressionChange = calculateChange(cleanNumber(today['Impr.']), data.dayBeforeYesterdayImpressions);

                if (cpmDropVsDayBefore < -0.2 && impressionChange > 0.2 && data.conversions === 0) {
                    issues.push({
                        level: 'HIGH',
                        module: 'ç¨³å®šæœŸ-ç‰ˆä½',
                        title: 'CPM ä¸‹é™ + æµé‡é™çº§é£é™©',
                        desc: `CPM ç¯æ¯”è·Œ ${Math.abs(cpmDropVsDayBefore * 100).toFixed(0)}%, å±•ç¤ºé‡æ¶¨ ${(impressionChange * 100).toFixed(0)}%, ä½† 0 è½¬åŒ–`,
                        diagnosis: 'æœºå™¨å¯èƒ½æ”¾å¼ƒäº†æ˜‚è´µçš„ Search/Shopping ç«ä»·ï¼Œè½¬è€Œå¤§é‡å¡«å…… Display (å±•ç¤ºç½‘ç»œ) æˆ– Mobile App çš„ä½ä»·åº“å­˜ã€‚è¿™é€šå¸¸ä¼´éšç€ CTR çš„è™šé«˜(è¯¯è§¦)å’Œ CVR çš„æš´è·Œã€‚',
                        action: '1. [Placement Check] æ£€æŸ¥ Placement Reportï¼Œå¦‚æœè·‘åˆ°äº† Displayã€Video ç‰ˆä½ä¸ºä¸»(App ç±»ç‰ˆä½ã€ä¸ç›¸å…³çš„ Youtube é¢‘é“ç‰ˆä½ æˆ– åŒ¿å/æ¸¸æˆç±»ç½‘ç«™)ï¼Œç«‹å³æ‰§è¡Œæ’é™¤è„šæœ¬ã€‚'
                    });
                }

                // CPM ä¸Šæ¶¨åˆ†æ
                if (cpmChange > 0.1) { // CPM ä¸Šæ¶¨è¶…è¿‡ 10%
                    // CPM ä¸Šæ¶¨ + CVR ä¸Šæ¶¨ (è‰¯æ€§)
                    if (cvrChange > 0) {
                        issues.push({
                            level: 'GOOD',
                            module: 'ç¨³å®šæœŸ-CPM',
                            title: 'CPM ä¸Šæ¶¨ (è‰¯æ€§/å“ç‰Œè¯å¸è¡€)',
                            desc: `CPM æ¶¨ ${(cpmChange * 100).toFixed(0)}%, CVR ä¹Ÿæå‡ ${(cvrChange * 100).toFixed(0)}%`,
                            diagnosis: 'æµé‡å˜è´µä½†æ›´ç²¾å‡†ã€‚å»ºè®®æ£€æŸ¥ Search Terms ä¸­å“ç‰Œè¯æ¶ˆè€—å æ¯”ï¼Œè‹¥ > 20% è¯´æ˜ PMax åœ¨æŠ¢ Brand Search æµé‡ã€‚',
                            action: 'è‹¥å“ç‰Œè¯å æ¯” > 20%: å»ºè®®æ·»åŠ  Brand Exclusion List; è‹¥ < 20%: æ— éœ€å¹²é¢„ã€‚'
                        });
                    } else if (cvrChange < -0.1) {
                        // CPM ä¸Šæ¶¨ + CVR ä¸‹é™ (ç«äº‰åŠ å‰§)
                        issues.push({
                            level: 'HIGH',
                            module: 'ç¨³å®šæœŸ-CPM',
                            title: 'CPM ä¸Šæ¶¨ + ç«äº‰åŠ å‰§',
                            desc: `CPM æ¶¨ ${(cpmChange * 100).toFixed(0)}%, ä½† CVR è·Œ ${Math.abs(cvrChange * 100).toFixed(0)}%`,
                            diagnosis: 'ç«äº‰åŠ å‰§ä¸”å¤„äºåŠ£åŠ¿ã€‚æµé‡å˜è´µä½†è½¬åŒ–åè€Œä¸‹é™ã€‚',
                            action: '1. æ£€æŸ¥ Auction Insightsï¼Œè‹¥è¿‡å»ä¸ƒå¤©ç«å¯¹ Impression Share ä¸Šå‡ï¼Œè¯´æ˜è¢«ç«å¯¹æŠ¢å ; 2. éœ€ä¼˜åŒ–ç´ æå·®å¼‚åŒ–ï¼Œæˆ–é¿å¼€çº¢æµ·è¯ã€‚'
                        });
                    }
                }
            }

            // === æ¨¡å—ä¸‰ï¼šROI æ·±åº¦è¯Šæ–­ ===

            // å­¦ä¹ æœŸ - é›¶è½¬åŒ–é£é™© (æ¼æ–—å µå¡)
            if (isLearning && data.cost > 2 * config.targetCpa && data.conversions === 0 && data.age >= 2) {
                const hasIc = data.ic > 0;
                issues.push({
                    level: 'CRITICAL',
                    module: 'ROIè¯Šæ–­-å­¦ä¹ æœŸ',
                    title: 'é›¶è½¬åŒ–é£é™© (Zero Conversion)',
                    desc: `æ¶ˆè€— $${data.cost.toFixed(2)} (>$${config.targetCpa * 2}) ä¸” 0 è½¬åŒ–`,
                    diagnosis: 'æµé‡å·²ç»å¼•å…¥ï¼Œä½†å¡åœ¨äº†æœ€åä¸€æ­¥ã€‚åœ¨æ’é™¤äº†æŠ€æœ¯/è¿½è¸ªæ•…éšœçš„å‰æä¸‹ï¼Œå¤§æ¦‚ç‡æ˜¯ä»·æ ¼/ä¿ƒé”€ç­–ç•¥å¯¼è‡´ç”¨æˆ·å†³ç­–å¤±è´¥ã€‚',
                    action: hasIc ?
                        '1. [Price Check] æœ‰ç»“è´¦æ„å‘ä½†ä¸è½¬åŒ–ï¼Œæ£€æŸ¥ä»·æ ¼æ˜¯å¦å¯¹æ¯”æŠ˜æ‰£æœŸè´µäº†ï¼Œæˆ–ä¼˜æƒ åˆ¸å·²è¿‡æœŸ; 2. å»ºè®®å¢åŠ æŒ½ç•™å¼¹çª—æˆ– EDM è¿½å•ã€‚' :
                        '1. [Price/Trust] å®Œå…¨æ— ç»“è´¦ï¼Œç”¨æˆ·è¿å°è¯•ç»“è´¦çš„åŠ¨åŠ›éƒ½æ²¡æœ‰; 2. è‡ªåŠ¨æŠ“å– GMC ä¸­ Top Spend SKU çš„ Price Competitivenessï¼Œè‹¥æ˜¾ç¤º "High" åˆ™å»ºè®®è°ƒæ•´å”®ä»·æˆ–å¼€å¯ä¿ƒé”€ã€‚',
                    triggerConditions: [
                        {
                            label: 'Cost > Target CPA Ã— 2',
                            actual: data.cost,
                            threshold: config.targetCpa * 2,
                            operator: '>',
                            passed: true,
                            format: 'currency'
                        },
                        {
                            label: 'è½¬åŒ–æ•° = 0',
                            actual: data.conversions,
                            threshold: 0,
                            operator: '=',
                            passed: true,
                            format: 'number'
                        },
                        {
                            label: 'å¹¿å‘Šç³»åˆ—å¹´é¾„ â‰¥ 2å¤©',
                            actual: data.age,
                            threshold: 2,
                            operator: 'â‰¥',
                            passed: true,
                            format: 'number'
                        }
                    ],
                    decisionPath: 'å­¦ä¹ æœŸ â†’ ROIæ£€æµ‹ â†’ é›¶è½¬åŒ–é£é™© â†’ ' + (hasIc ? 'æœ‰ICæ— Purchase' : 'å®Œå…¨æ— äº¤äº’')
                });
            }

            // å­¦ä¹ æœŸ - è½¬åŒ–æˆæœ¬æé«˜ (Extreme CPA)
            if (isLearning && data.cpa > 3 * config.targetCpa && data.conversions > 0) {
                issues.push({
                    level: 'CRITICAL',
                    module: 'ROIè¯Šæ–­-å­¦ä¹ æœŸ',
                    title: 'è½¬åŒ–æˆæœ¬æé«˜ (Extreme CPA)',
                    desc: `CPA $${data.cpa.toFixed(2)} æ˜¯ç›®æ ‡çš„ ${(data.cpa / config.targetCpa).toFixed(1)} å€`,
                    diagnosis: 'è™½ç„¶å‡ºå•äº†ï¼Œä½†è¿™ä¸€å•çš„æˆæœ¬æ˜¯ç›®æ ‡çš„ 3 å€ï¼Œè¿™ä¹°å–åšä¸ä¸‹å»ã€‚æœºå™¨åœ¨æå…¶é”™è¯¯çš„äººç¾¤æˆ–ç‰ˆä½ä¸Šæµªè´¹äº†å¤ªå¤šé¢„ç®—ã€‚',
                    action: '1. [Stop Loss] é¢å¯¹ 3 å€ CPA çš„å­¦ä¹ æœŸæ¨¡å‹ï¼Œä¿®è¡¥çš„æˆæœ¬å¾€å¾€é«˜äºé‡å»ºã€‚å»ºè®®æš‚åœè¯¥ Campaignï¼Œå¤åˆ¶å®ƒï¼Œæ›´æ¢æ›´çª„çš„å—ä¼—ä¿¡å·(å¦‚ä»…ä½¿ç”¨å…·ä½“å‹å·çš„ Search Themesï¼Œå»æ‰å®½æ³›å…´è¶£)åé‡å¯; 2. æ£€æŸ¥æ˜¯å¦å¼€å¯äº† Final URL Expansion ä¸”æµé‡è·‘å‘äº†æ— å…³é¡µé¢(Blog/Policy)ã€‚',
                    triggerConditions: [
                        {
                            label: 'CPA > Target CPA Ã— 3',
                            actual: data.cpa,
                            threshold: config.targetCpa * 3,
                            operator: '>',
                            passed: true,
                            format: 'currency'
                        },
                        {
                            label: 'è½¬åŒ–æ•° > 0',
                            actual: data.conversions,
                            threshold: 0,
                            operator: '>',
                            passed: true,
                            format: 'number'
                        }
                    ],
                    decisionPath: 'å­¦ä¹ æœŸ â†’ ROIæ£€æµ‹ â†’ æé«˜CPAç†”æ–­'
                });
            }

            // ç¨³å®šæœŸ - é›¶è½¬åŒ– (Dead Campaign)
            if (!isLearning && data.conversions === 0 && data.yesterdayConversions === 0 && data.cost > 600) {
                issues.push({
                    level: 'CRITICAL',
                    module: 'ROIè¯Šæ–­-ç¨³å®šæœŸ',
                    title: 'é›¶è½¬åŒ– (Dead Campaign)',
                    desc: `è¿ç»­ 2 å¤© 0 è½¬åŒ–ï¼Œç´¯è®¡æ¶ˆè€— $${data.cost.toFixed(2)}`,
                    diagnosis: 'æ¨¡å‹"æ­»é”"ã€‚å¯èƒ½æ˜¯å—ä¼—æ± æ¯ç«­(è¯¥ä¹°çš„éƒ½ä¹°äº†)ã€äº§å“ç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œæˆ–è€…æœºå™¨é™·å…¥äº†é”™è¯¯çš„æµé‡æ¢ç´¢æ­»èƒ¡åŒã€‚',
                    action: '1. [Reboot] å»ºè®®æš‚åœ Campaignï¼Œå¤åˆ¶æ–°å»ºã€‚PMax æœ‰æ—¶éœ€è¦"é‡å¯"æ¥æ¸…é™¤é”™è¯¯çš„æœºå™¨å­¦ä¹ ç¼“å­˜; 2. [New Blood] æ–° Campaign å¿…é¡»ä½¿ç”¨å…¨æ–°çš„ç´ æå’Œå…¨æ–°çš„å—ä¼—ä¿¡å·(ä¾‹å¦‚:ä»å…´è¶£æ ‡ç­¾æ”¹ä¸ºç«å“ç½‘å€å®šå‘)ã€‚',
                    triggerConditions: [
                        {
                            label: 'ä»Šå¤©è½¬åŒ– = 0',
                            actual: data.conversions,
                            threshold: 0,
                            operator: '=',
                            passed: true,
                            format: 'number'
                        },
                        {
                            label: 'æ˜¨å¤©è½¬åŒ– = 0',
                            actual: data.yesterdayConversions,
                            threshold: 0,
                            operator: '=',
                            passed: true,
                            format: 'number'
                        },
                        {
                            label: 'ç´¯è®¡æ¶ˆè€— > $600',
                            actual: data.cost,
                            threshold: 600,
                            operator: '>',
                            passed: true,
                            format: 'currency'
                        }
                    ],
                    decisionPath: 'ç¨³å®šæœŸ â†’ ROIæ£€æµ‹ â†’ æ¨¡å‹æ­»é”'
                });
            }

            // é…ä»¶é™·é˜± (å­¦ä¹ æœŸå’Œç¨³å®šæœŸé€šç”¨)
            if (data.conversions > 2 && data.aov < (config.targetAov / 2)) {
                issues.push({
                    level: 'HIGH',
                    module: 'ROIè¯Šæ–­',
                    title: 'é…ä»¶é™·é˜± (Low AOV)',
                    desc: `AOV $${data.aov.toFixed(2)} è¿œä½äºç›®æ ‡ $${config.targetAov}`,
                    diagnosis: 'æœºå™¨è§‰å¾—å–ä¸€ä¸ª $50 çš„é…ä»¶å’Œä¸€ä¸ª $2500 çš„ç”µæºæ˜¯ä¸€æ ·çš„"1ä¸ªè½¬åŒ–"ï¼Œè‡ªç„¶ä¼šå»æ¨æ›´å®¹æ˜“æˆäº¤çš„ä½ä»·å“ã€‚',
                    action: '1. [Strategy] å°†å‡ºä»·ç­–ç•¥æ”¹ä¸º "Maximize Conversion Value"; 2. [Inventory] åœ¨ Listing Group ä¸­æ’é™¤ä½ä»· SKU; 3. [Audience] å¢åŠ "é«˜å®¢å•ä»·æ„å›¾"çš„ Search Themesï¼Œç§»é™¤åŒ…å«é…ä»¶çš„è¯; 4. [Negative] æ£€æŸ¥ Search Termsï¼Œå°†é…ä»¶ç›¸å…³è¯åŠ å…¥å¦å®šåˆ—è¡¨ã€‚'
                });
            }

            // ç¨³å®šæœŸ - CPA æ­£å¸¸ä½† AOV è¿‡ä½
            if (!isLearning && data.cpa < config.targetCpa && data.aov < (config.targetAov * 0.7) && data.roas < config.targetRoas) {
                issues.push({
                    level: 'HIGH',
                    module: 'ROIè¯Šæ–­-ç¨³å®šæœŸ',
                    title: 'CPA æ­£å¸¸ä½† AOV è¿‡ä½',
                    desc: `CPA $${data.cpa.toFixed(2)} è¾¾æ ‡ï¼Œä½† AOV $${data.aov.toFixed(2)} ä»…ä¸ºç›®æ ‡çš„ ${((data.aov / config.targetAov) * 100).toFixed(0)}%`,
                    diagnosis: 'å–å¾—å¤ªä¾¿å®œã€‚æœºå™¨ä¸ºäº†å‡‘è½¬åŒ–æ•°é‡ï¼Œæ‹¼å‘½æ¨å¥½å–çš„ä½ä»·é…ä»¶/å¼•æµæ¬¾ï¼Œå¯¼è‡´è™½ç„¶å‡ºå•äº†ï¼Œä½†æ€» GMV ä¸Šä¸å»ã€‚',
                    action: '1. [ç­–ç•¥ä¿®æ­£] ç¡®è®¤å‡ºä»·ç­–ç•¥æ˜¯å¦ä¸¥æ ¼æ‰§è¡Œ Maximize Conversion Value; 2. [ç‰©ç†éš”ç¦»] åœ¨ Listing Group ä¸­å°†ä»·æ ¼ä½äº AOVÃ—0.7 çš„ SKU è®¾ä¸º Exclude; 3. [ä¿¡å·å¼•å¯¼] åœ¨ Search Themes ä¸­ç§»é™¤é…ä»¶è¯ï¼Œåªä¿ç•™å‹å·è¯ã€‚'
                });
            }

            // ROI ä¸è¾¾æ ‡
            if (data.roas < config.targetRoas && data.cost > 50) {
                issues.push({
                    level: 'HIGH',
                    module: 'ROIè¯Šæ–­',
                    title: 'ROI ä¸è¾¾æ ‡',
                    desc: `ROAS ${data.roas.toFixed(2)} < Target ${config.targetRoas}`,
                    diagnosis: 'è´¦æˆ·æ··å…¥ä½æ•ˆ SKU æˆ–ç´ æã€‚',
                    action: 'æ’é™¤ä½æ•ˆ SKU (Cost é«˜ ROAS ä½)ï¼Œå¦å®šæ— å…³æœç´¢è¯ã€‚'
                });
            }

            // ç‰ˆä½è·‘å (ç¨³å®šæœŸ)
            if (!isLearning && data.displayVideoCostShare > 60) {
                issues.push({
                    level: 'HIGH',
                    module: 'ç‰ˆä½è¯Šæ–­',
                    title: 'ç‰ˆä½è·‘åé£é™©',
                    desc: `Display/Video å æ¯” ${data.displayVideoCostShare.toFixed(1)}%`,
                    diagnosis: 'è§†é¢‘/å±•ç¤ºç‰ˆä½æ¶ˆè€—è¿‡é«˜ï¼Œé€šå¸¸è½¬åŒ–è¾ƒå·®ã€‚',
                    action: 'ä¸Šä¼ æ›´"ç¡¬"çš„äº§å“è§†é¢‘ï¼Œæˆ–æ’é™¤ä½æ•ˆç´ æã€‚'
                });
            }

            return { data, issues };
        }

        function calculateAge(row) {
            const campaignName = row['Campaign'] || '';
            const match = campaignName.match(/(\d{8})/);
            if (match) {
                const startStr = match[1];
                const startDate = new Date(`${startStr.substring(0, 4)}-${startStr.substring(4, 6)}-${startStr.substring(6, 8)}`);
                const currDate = parseDate(row['Day']);
                const diffTime = Math.abs(currDate - startDate);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }
            return 7; // é»˜è®¤å‡è®¾ç¨³å®šæœŸ
        }

        // ============================================
        // æ•°æ®å¤„ç†
        // ============================================
        function processData(csvText) {
            const rawData = parseCSV(csvText);
            if (rawData.length === 0) {
                alert('æ— æ³•è§£æ CSV æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ ¼å¼ã€‚');
                return;
            }

            // æŒ‰ Campaign åˆ†ç»„
            const groups = {};
            rawData.forEach(row => {
                const name = row['Campaign'];
                if (!groups[name]) groups[name] = [];
                groups[name].push(row);
            });

            // ä¿å­˜åˆ°å…¨å±€å˜é‡
            globalCampaignData = {};

            // åˆ†ææ¯ä¸ª Campaign
            const results = Object.keys(groups).map(campaignName => {
                // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
                const sortedRows = groups[campaignName].sort((a, b) => {
                    return parseDate(b['Day']) - parseDate(a['Day']);
                });

                // ä¿å­˜å·²æ’åºçš„æ•°æ®
                globalCampaignData[campaignName] = sortedRows;

                return analyzeCampaign(sortedRows);
            });

            // å¯ç”¨é‡æ–°è¯Šæ–­æŒ‰é’®
            document.getElementById('reanalyzeBtn').disabled = false;

            renderResults(results);
        }

        // ============================================
        // UI æ¸²æŸ“
        // ============================================
        function renderResults(results) {
            const content = document.getElementById('content');

            // ç»Ÿè®¡é—®é¢˜æ•°é‡
            let criticalCount = 0, highCount = 0, mediumCount = 0, goodCount = 0;
            results.forEach(r => {
                r.issues.forEach(i => {
                    if (i.level === 'CRITICAL') criticalCount++;
                    else if (i.level === 'HIGH') highCount++;
                    else if (i.level === 'MEDIUM') mediumCount++;
                    else if (i.level === 'GOOD') goodCount++;
                });
            });

            let html = `
        <div class="report-header">
          <div>
            <h2 class="report-title">è¯Šæ–­æŠ¥å‘Š</h2>
            <p class="report-meta">æ£€æµ‹åˆ° ${results.length} ä¸ªå¹¿å‘Šç³»åˆ—ï¼ŒåŸºå‡†æ—¥æœŸï¼š${results[0]?.data?.date || '-'}</p>
          </div>
          <div class="badge-group">
            ${criticalCount > 0 ? `<span class="badge badge-critical">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              Critical: ${criticalCount}
            </span>` : ''}
            ${highCount > 0 ? `<span class="badge badge-high">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              High: ${highCount}
            </span>` : ''}
            ${mediumCount > 0 ? `<span class="badge badge-medium">Medium: ${mediumCount}</span>` : ''}
            ${goodCount > 0 ? `<span class="badge badge-good">Good: ${goodCount}</span>` : ''}
          </div>
        </div>
      `;

            results.forEach((result, idx) => {
                const { data, issues } = result;
                if (!data.name) return;

                const roasColor = data.roas >= config.targetRoas ? 'metric-good' : 'metric-danger';
                const cpaColor = data.cpa <= config.targetCpa ? 'metric-good' : (data.cpa <= config.targetCpa * 1.5 ? 'metric-warning' : 'metric-danger');

                html += `
          <div class="campaign-card">
            <div class="campaign-header">
              <div class="campaign-name">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="3" y1="9" x2="21" y2="9"></line>
                  <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
                ${data.name}
                <span class="campaign-age">${data.age <= 3 ? 'ğŸ”„ å­¦ä¹ æœŸ' : 'âœ… ç¨³å®šæœŸ'} Day ${data.age}</span>
              </div>
              <div class="campaign-metrics">
                <div class="metric-item">
                  <div class="metric-value ${roasColor}">${data.roas.toFixed(2)}</div>
                  <div class="metric-label">ROAS</div>
                </div>
                <div class="metric-item">
                  <div class="metric-value ${cpaColor}">$${data.cpa.toFixed(0)}</div>
                  <div class="metric-label">CPA</div>
                </div>
                <div class="metric-item">
                  <div class="metric-value">$${data.cost.toFixed(0)}</div>
                  <div class="metric-label">Cost</div>
                </div>
                <div class="metric-item">
                  <div class="metric-value">${data.conversions}</div>
                  <div class="metric-label">Conv</div>
                </div>
              </div>
            </div>
            <div class="campaign-body">
              ${issues.length > 0 ? `
                <div class="issues-list">
                  ${issues.map(issue => `
                    <div class="issue-item issue-${issue.level.toLowerCase()}">
                      <div class="issue-header">
                        <span class="issue-module">${issue.module}</span>
                        <span class="badge badge-${issue.level.toLowerCase()}">${issue.level}</span>
                      </div>
                      <div class="issue-title">${issue.title}</div>
                      <div class="issue-desc">${issue.desc}</div>
                      <div class="issue-diagnosis">ğŸ’¡ ${issue.diagnosis}</div>
                      <div class="issue-action">
                        <svg class="issue-action-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="9 11 12 14 22 4"></polyline>
                          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                        <span>${issue.action}</span>
                      </div>
                      ${renderTriggerSection(issue)}
                    </div>
                  `).join('')}
                </div>
              ` : `
                <div class="no-issues">
                  <svg class="no-issues-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                  <p class="no-issues-text">è¡¨ç°æ­£å¸¸ï¼Œæ— éœ€å¹²é¢„</p>
                </div>
              `}
            </div>
          </div>
        `;
            });

            content.innerHTML = html;
        }

        // ============================================
        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        // ============================================
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    processData(e.target.result);
                };
                reader.readAsText(file);
            }
        }

        // æ‹–æ‹½ä¸Šä¼ 
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    processData(ev.target.result);
                };
                reader.readAsText(file);
            } else {
                alert('è¯·ä¸Šä¼  CSV æ ¼å¼æ–‡ä»¶');
            }
        });

        // ============================================
        // æ¼”ç¤ºæ•°æ®
        // ============================================
        // ============================================
        // æ¼”ç¤ºæ•°æ®
        // ============================================
        function loadDemoData() {
            const csv = `Campaign,Day,Budget,Cost,Impr.,Clicks,CPM,CTR,CPC,ATC,CPATC,IC,CPIC,Purchase,CPA,é”€å”®é¢,ROI,CVR,AOV,Impression Share,Conversion Actions,Conversion volume,GMC Status,Policy Review Status,Asset Approval Status,Product Disapproval Rate,ç‰ˆä½è·‘åè¯Šæ–­ï¼ˆcostï¼šdisplay+videoå æ¯”ï¼‰,Videoç‰ˆä½èŠ±è´¹å æ¯”
US-20251210-Google-CV-PMax-Purchase-MaxConv-HighIndex-3600Plus-Event-Mix-GOC,2026/1/5,144,$167.08 ,"11,533",120,$14.49 ,1.04%,$1.39 ,5,$31.28 ,1,$215.34 ,0,$732.90 ,$561.18 ,3.95,0.08%,"$3,142.28 ",<10,Active,274.83,Linked,è´¦æˆ·ç›®å‰ä¸æ¶‰åŠpolicy issuesæ‰€ä»¥è¿™ä¸€æ éƒ½æ˜¯ç©ºçš„,7Ã—pausedï¼Œ2Ã—eligible,97.60%,1.57%,0.15%
US-20251210-Google-CV-PMax-Purchase-MaxConv-HighIndex-3600Plus-Event-Mix-GOC,2026/1/6,144,$178.60 ,"7,734",105,$23.09 ,1.36%,$1.70 ,0,$0.00 ,1,$67.58 ,1,$67.58 ,"$3,099.00 ",45.85,0.56%,"$3,099.00 ",<10,Active,183.8,Linked,è´¦æˆ·ç›®å‰ä¸æ¶‰åŠpolicy issuesæ‰€ä»¥è¿™ä¸€æ éƒ½æ˜¯ç©ºçš„,7Ã—pausedï¼Œ2Ã—eligible,97.60%,2.97%,0.00%
US-20251210-Google-CV-PMax-Purchase-MaxConv-HighIndex-3600Plus-Event-Mix-GOC,2026/1/7,144,$176.04 ,"10,977",97,$16.04 ,0.88%,$1.81 ,2,$88.02 ,0,$0.00 ,1,$176.04 ,$799.00 ,4.54,0.53%,$799.00 ,<10,Active,337.67,Linked,è´¦æˆ·ç›®å‰ä¸æ¶‰åŠpolicy issuesæ‰€ä»¥è¿™ä¸€æ éƒ½æ˜¯ç©ºçš„,7Ã—pausedï¼Œ2Ã—eligible,97.60%,0.44%,0.06%
US-20251210-Google-CV-PMax-Purchase-MaxConv-HighIndex-3600Plus-Event-Mix-GOC,2026/1/8,144,$142.09 ,"9,728",94,$14.61 ,0.97%,$1.51 ,3,$55.36 ,0,$354.56 ,0,$0.00 ,$0.00 ,0,0%,$0.00 ,<10,Active,363.21,Linked,è´¦æˆ·ç›®å‰ä¸æ¶‰åŠpolicy issuesæ‰€ä»¥è¿™ä¸€æ éƒ½æ˜¯ç©ºçš„,7Ã—pausedï¼Œ2Ã—eligible,97.60%,0.34%,0.00%
US-20251210-Google-CV-PMax-Purchase-MaxConv-HighIndex-3600Plus-Event-Mix-GOC,2026/1/9,144,$100.70 ,"9,321",77,$10.80 ,0.83%,$1.31 ,11,$14.31 ,0,$0.00 ,0,$0.00 ,$0.00 ,0,0%,$0.00 ,<10,Active,281.17,Linked,è´¦æˆ·ç›®å‰ä¸æ¶‰åŠpolicy issuesæ‰€ä»¥è¿™ä¸€æ éƒ½æ˜¯ç©ºçš„,7Ã—pausedï¼Œ2Ã—eligible,97.60%,1.57%,0.81%
US-20251210-Google-CV-PMax-Purchase-MaxConv-HighIndex-3600Plus-Event-Mix-GOC,2026/1/10,144,$157.45 ,"4,441",76,$35.45 ,1.71%,$2.07 ,0,$0.00 ,0,$0.00 ,0,$0.00 ,$0.00 ,0,0%,$0.00 ,<10,Active,329.6,Linked,è´¦æˆ·ç›®å‰ä¸æ¶‰åŠpolicy issuesæ‰€ä»¥è¿™ä¸€æ éƒ½æ˜¯ç©ºçš„,7Ã—pausedï¼Œ2Ã—eligible,97.60%,1.44%,0.75%
US-20251210-Google-CV-PMax-Purchase-MaxConv-HighIndex-3600Plus-Event-Mix-GOC,2026/1/11,144,$67.58 ,"8,034",64,$8.41 ,0.80%,$1.06 ,0,$302.09 ,1,$100.70 ,0,$0.00 ,$0.00 ,0,0%,$0.00 ,<10,Active,199.09,Linked,è´¦æˆ·ç›®å‰ä¸æ¶‰åŠpolicy issuesæ‰€ä»¥è¿™ä¸€æ éƒ½æ˜¯ç©ºçš„,7Ã—pausedï¼Œ2Ã—eligible,97.60%,1.75%,0.33%`;

            processData(csv);
        }

        // åˆå§‹åŒ–é…ç½®
        updateConfig();
    </script>
</body>

</html>