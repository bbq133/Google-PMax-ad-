# Pmax 数据汇总计算逻辑说明

## 问题背景

当导入包含**多天数据**的 CSV 文件时(如 `Pmax数据11.csv` 包含 2026/1/5 到 2026/1/11 共7天数据),原系统只读取**最新一天**的数据进行展示,导致:

- 如果最新一天转化为 0,则显示 **ROAS = 0.00**
- **CPA** 计算异常(除以0)
- **总花费**只显示最新一天,而非整个周期

这与用户期望的**整体表现评估**不符。

---

## 修复后的计算逻辑

### 1️⃣ 数据汇总阶段

系统会**遍历所有天数的数据**,累加以下核心指标:

```javascript
historyData.forEach(row => {
    totalCost += cleanNumber(row['Cost']);              // 累加花费
    totalConversions += cleanNumber(row['Purchase']);   // 累加转化数
    totalConvValue += cleanNumber(row['销售额']);        // 累加销售额
    totalClicks += cleanNumber(row['Clicks']);          // 累加点击数
    totalImpressions += cleanNumber(row['Impr.']);      // 累加展示数
    totalAtc += cleanNumber(row['ATC']);                // 累加加购数
    totalIc += cleanNumber(row['IC']);                  // 累加发起结账数
});
```

**以 `Pmax数据11.csv` 为例:**

| 日期 | Cost | Purchase | 销售额 |
|------|------|----------|--------|
| 1/5  | $167.08 | 0 | $561.18 |
| 1/6  | $178.60 | 1 | $3,099.00 |
| 1/7  | $176.04 | 1 | $799.00 |
| 1/8  | $142.09 | 0 | $0.00 |
| 1/9  | $100.70 | 0 | $0.00 |
| 1/10 | $157.45 | 0 | $0.00 |
| 1/11 | $67.58  | 0 | $0.00 |
| **汇总** | **$989.54** | **2** | **$4,459.18** |

---

### 2️⃣ 核心指标计算

基于汇总数据,计算关键业务指标:

#### **ROAS (广告支出回报率)**
```javascript
aggregatedRoas = totalConvValue / totalCost
```
- **计算结果**: $4,459.18 / $989.54 ≈ **4.51**
- **业务含义**: 每花 $1 带来 $4.51 的销售额

#### **CPA (单次转化成本)**
```javascript
aggregatedCpa = totalCost / totalConversions
```
- **计算结果**: $989.54 / 2 ≈ **$495**
- **业务含义**: 每个转化平均花费 $495

#### **AOV (客单价)**
```javascript
aggregatedAov = totalConvValue / totalConversions
```
- **计算结果**: $4,459.18 / 2 ≈ **$2,230**
- **业务含义**: 每个订单平均价值 $2,230

#### **CVR (转化率)**
```javascript
aggregatedCvr = (totalConversions / totalClicks) * 100
```
- **计算结果**: (2 / 633) × 100 ≈ **0.32%**

#### **CTR (点击率)**
```javascript
aggregatedCtr = (totalClicks / totalImpressions) * 100
```
- **计算结果**: (633 / 61,768) × 100 ≈ **1.02%**

---

### 3️⃣ 混合策略

并非所有指标都适合汇总,系统采用**混合策略**:

| 指标类型 | 数据来源 | 原因 |
|---------|---------|------|
| **Cost, Conversions, Revenue** | ✅ 汇总所有天 | 需要整体表现评估 |
| **ROAS, CPA, AOV, CVR, CTR** | ✅ 基于汇总数据计算 | 反映整体效率 |
| **CPM, CPC** | ⚠️ 仅最新一天 | 反映当前竞价环境 |
| **Budget** | ⚠️ 仅最新一天 | 预算是当前设置值 |
| **版位分布, 审核状态** | ⚠️ 仅最新一天 | 状态类数据取最新 |

---

## 修复前后对比

### ❌ 修复前(仅读取 1/11 数据)
```
ROAS: 0.00      ← 因为当天转化为 0
CPA: $0         ← 除以 0 导致异常
Cost: $68       ← 仅当天花费
Conv: 0         ← 仅当天转化
```

### ✅ 修复后(汇总 7 天数据)
```
ROAS: 4.51      ← $4,459 / $990 = 4.51
CPA: $495       ← $990 / 2 = $495
Cost: $990      ← 7 天总花费
Conv: 2         ← 7 天总转化
```

---

## 业务价值

1. **准确评估广告表现**: 避免因单日波动导致误判
2. **支持多日数据导入**: 适配日报表、周报表等不同场景
3. **诊断逻辑更可靠**: 基于整体数据的诊断建议更有参考价值

---

## 技术实现位置

修改文件: `pmax-analyzer.html`  
修改函数: `analyzeCampaign()` (第 801-865 行)

核心改动:
- 新增数据汇总循环 (遍历 `historyData`)
- 基于汇总值计算 ROAS/CPA/AOV/CVR/CTR
- 保留最新一天的 CPM/CPC/状态信息
